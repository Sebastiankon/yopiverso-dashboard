<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard Yopiverso - Laive</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/4.4.0/chart.umd.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.20.0/xlsx.full.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: linear-gradient(135deg, #0a0e27 0%, #151c3c 100%);
            color: #ffffff;
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
        }

        .header {
            text-align: center;
            margin-bottom: 40px;
            animation: fadeInDown 0.8s ease-out;
        }

        .header h1 {
            font-size: 3rem;
            margin-bottom: 10px;
            background: linear-gradient(45deg, #ff6b6b, #4ecdc4);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .header p {
            color: #a0a0a0;
            font-size: 1.2rem;
        }

        .controls {
            background: rgba(255, 255, 255, 0.05);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            padding: 30px;
            margin-bottom: 30px;
            border: 1px solid rgba(255, 255, 255, 0.1);
            animation: fadeInUp 0.8s ease-out 0.2s both;
        }

        .control-group {
            display: flex;
            flex-wrap: wrap;
            gap: 20px;
            align-items: center;
            justify-content: space-between;
        }

        .file-upload-section {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        .file-status {
            background: rgba(255, 255, 255, 0.03);
            padding: 15px;
            border-radius: 15px;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .file-status p {
            margin: 0 0 10px 0;
            color: #a0a0a0;
            font-size: 0.9rem;
        }

        .file-indicators {
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
            margin-bottom: 10px;
        }

        .file-indicator {
            padding: 5px 15px;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 20px;
            font-size: 0.85rem;
            border: 1px solid rgba(255, 255, 255, 0.1);
            transition: all 0.3s ease;
        }

        .file-indicator.loaded {
            background: rgba(78, 205, 196, 0.2);
            border-color: #4ecdc4;
            color: #4ecdc4;
        }

        .file-count {
            font-size: 0.9rem;
            color: #ffd93d;
            margin: 5px 0 0 0;
        }

        .success-message {
            background: rgba(78, 205, 196, 0.2);
            color: #4ecdc4;
            padding: 15px;
            border-radius: 10px;
            margin: 10px 0;
            display: none;
        }

        .success-message.active {
            display: block;
        }

        .file-upload input[type="file"] {
            position: absolute;
            opacity: 0;
            width: 100%;
            height: 100%;
            cursor: pointer;
        }

        .file-upload label {
            display: inline-block;
            padding: 12px 24px;
            background: linear-gradient(45deg, #ff6b6b, #4ecdc4);
            color: white;
            border-radius: 30px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-weight: 600;
        }

        .file-upload label:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(255, 107, 107, 0.3);
        }

        .date-filters {
            display: flex;
            gap: 15px;
            align-items: center;
        }

        .date-filters input[type="date"] {
            padding: 10px 15px;
            border: 1px solid rgba(255, 255, 255, 0.2);
            background: rgba(255, 255, 255, 0.1);
            color: white;
            border-radius: 10px;
            font-size: 16px;
        }

        .date-filters input[type="date"]::-webkit-calendar-picker-indicator {
            filter: invert(1);
        }

        .btn-filter {
            padding: 10px 20px;
            background: linear-gradient(45deg, #4ecdc4, #44a08d);
            color: white;
            border: none;
            border-radius: 25px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s ease;
        }

        .btn-filter:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(78, 205, 196, 0.3);
        }

        .metrics-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .metric-card {
            background: rgba(255, 255, 255, 0.05);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            padding: 25px;
            border: 1px solid rgba(255, 255, 255, 0.1);
            text-align: center;
            transition: all 0.3s ease;
            animation: fadeInUp 0.8s ease-out;
        }

        .metric-card:hover {
            transform: translateY(-5px);
            border-color: rgba(255, 255, 255, 0.3);
            box-shadow: 0 15px 30px rgba(0, 0, 0, 0.3);
        }

        .metric-value {
            font-size: 2.5rem;
            font-weight: 700;
            margin-bottom: 10px;
            background: linear-gradient(45deg, #ff6b6b, #4ecdc4);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .metric-label {
            color: #a0a0a0;
            font-size: 1rem;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .charts-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(500px, 1fr));
            gap: 30px;
            margin-bottom: 30px;
        }

        .chart-container {
            background: rgba(255, 255, 255, 0.05);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            padding: 30px;
            border: 1px solid rgba(255, 255, 255, 0.1);
            animation: fadeInUp 0.8s ease-out;
        }

        .chart-container h3 {
            margin-bottom: 20px;
            font-size: 1.3rem;
            color: #ffffff;
        }

        .data-table {
            background: rgba(255, 255, 255, 0.05);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            padding: 30px;
            border: 1px solid rgba(255, 255, 255, 0.1);
            overflow-x: auto;
            animation: fadeInUp 0.8s ease-out;
            margin-bottom: 30px;
        }

        table {
            width: 100%;
            border-collapse: collapse;
        }

        th, td {
            padding: 15px;
            text-align: left;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        th {
            background: rgba(255, 255, 255, 0.1);
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 1px;
            font-size: 0.9rem;
        }

        tr:hover {
            background: rgba(255, 255, 255, 0.05);
        }

        .status-badge {
            display: inline-block;
            padding: 5px 15px;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: 600;
        }

        .status-active {
            background: rgba(78, 205, 196, 0.2);
            color: #4ecdc4;
        }

        .status-completed {
            background: rgba(255, 107, 107, 0.2);
            color: #ff6b6b;
        }

        @keyframes fadeInDown {
            from {
                opacity: 0;
                transform: translateY(-30px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        @keyframes fadeInUp {
            from {
                opacity: 0;
                transform: translateY(30px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .loading {
            display: none;
            text-align: center;
            padding: 20px;
            color: #4ecdc4;
        }

        .loading.active {
            display: block;
        }

        .error-message {
            background: rgba(255, 107, 107, 0.2);
            color: #ff6b6b;
            padding: 15px;
            border-radius: 10px;
            margin: 10px 0;
            display: none;
        }

        .error-message.active {
            display: block;
        }

        .download-section {
            background: rgba(78, 205, 196, 0.1);
            border: 2px solid #4ecdc4;
            border-radius: 20px;
            padding: 30px;
            margin: 30px 0;
            text-align: center;
            animation: fadeInUp 0.8s ease-out;
        }

        .download-container h3 {
            color: #4ecdc4;
            margin-bottom: 15px;
        }

        .download-container p {
            color: #a0a0a0;
            margin-bottom: 20px;
        }

        .btn-download {
            padding: 15px 30px;
            background: linear-gradient(45deg, #4ecdc4, #44a08d);
            color: white;
            border: none;
            border-radius: 30px;
            cursor: pointer;
            font-weight: 600;
            font-size: 1.1rem;
            transition: all 0.3s ease;
        }

        .btn-download:hover {
            transform: translateY(-3px);
            box-shadow: 0 15px 30px rgba(78, 205, 196, 0.4);
        }

        @media (max-width: 768px) {
            .header h1 {
                font-size: 2rem;
            }
            
            .control-group {
                flex-direction: column;
                align-items: stretch;
            }
            
            .date-filters {
                flex-direction: column;
                width: 100%;
            }
            
            .date-filters input[type="date"] {
                width: 100%;
            }
            
            .charts-grid {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>Dashboard Yopiverso</h1>
            <p>Monitor de rendimiento de campa√±a - Laive</p>
        </div>

        <div class="controls">
            <div class="control-group">
                <div class="file-upload-section">
                    <div class="file-upload">
                        <input type="file" id="fileInput" accept=".csv,.xlsx,.xls" multiple>
                        <label for="fileInput">üìä Cargar m√∫ltiples archivos (CSV/Excel)</label>
                    </div>
                    <div class="file-status" id="fileStatus">
                        <p>Archivos esperados:</p>
                        <div class="file-indicators">
                            <span class="file-indicator" id="csvIndicator">üìÑ CSV Experiencia</span>
                            <span class="file-indicator" id="excel1Indicator">üìä Excel Roblox 1</span>
                            <span class="file-indicator" id="excel2Indicator">üìä Excel Roblox 2</span>
                        </div>
                        <p class="file-count" id="fileCount">Selecciona los 3 archivos simult√°neamente</p>
                    </div>
                </div>
                
                <div class="date-filters">
                    <label>Desde:</label>
                    <input type="date" id="startDate">
                    <label>Hasta:</label>
                    <input type="date" id="endDate">
                    <button class="btn-filter" onclick="applyFilters()">Filtrar</button>
                    <button class="btn-filter" onclick="resetFilters()">Resetear</button>
                    <div style="margin-top: 10px; font-size: 0.85rem; color: #a0a0a0;">
                        <span id="dateRangeInfo">Mostrando todos los datos disponibles</span>
                    </div>
                </div>
            </div>
            <div class="loading" id="loading">Cargando datos...</div>
            <div class="error-message" id="errorMessage"></div>
            <div class="success-message" id="successMessage"></div>
        </div>

        <div class="metrics-grid" id="metricsGrid">
            <div class="metric-card">
                <div class="metric-value" id="totalUsers">0</div>
                <div class="metric-label">Usuarios Activos (Per√≠odo)</div>
            </div>
            <div class="metric-card">
                <div class="metric-value" id="newUsers">0</div>
                <div class="metric-label">Nuevos Usuarios (Per√≠odo)</div>
            </div>
            <div class="metric-card">
                <div class="metric-value" id="totalVisits">0</div>
                <div class="metric-label">Visitas (Per√≠odo)</div>
            </div>
            <div class="metric-card">
                <div class="metric-value" id="avgSessionTime">0</div>
                <div class="metric-label">Tiempo Sesi√≥n Prom. (min)</div>
            </div>
            <div class="metric-card">
                <div class="metric-value" id="avgRetention">0%</div>
                <div class="metric-label">Retenci√≥n D√≠a 1 Prom.</div>
            </div>
        </div>

        <div class="charts-grid">
            <div class="chart-container">
                <h3>üìà Usuarios Activos Diarios</h3>
                <canvas id="usersChart"></canvas>
            </div>
            <div class="chart-container">
                <h3>üìä Visitas Totales</h3>
                <canvas id="visitsChart"></canvas>
            </div>
        </div>

        <div class="charts-grid">
            <div class="chart-container">
                <h3>‚è±Ô∏è Tiempo de Sesi√≥n Promedio</h3>
                <canvas id="sessionChart"></canvas>
            </div>
            <div class="chart-container">
                <h3>üîÑ Retenci√≥n D√≠a 1</h3>
                <canvas id="retentionChart"></canvas>
            </div>
        </div>

        <div class="data-table" id="campaignsTableContainer">
            <h3>üìä Campa√±as de Roblox Ads</h3>
            <div style="overflow-x: auto;">
                <table id="campaignsTable">
                    <thead>
                        <tr>
                            <th>Campa√±a</th>
                            <th>Objetivo</th>
                            <th>Presupuesto</th>
                            <th>Gastado</th>
                            <th>Impresiones</th>
                            <th>Plays</th>
                            <th>CPP</th>
                            <th>Estado</th>
                        </tr>
                    </thead>
                    <tbody id="campaignsBody">
                        <tr>
                            <td colspan="8" style="text-align: center; color: #a0a0a0;">
                                No hay datos de campa√±as cargados
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>

        <div class="download-section" id="downloadSection" style="display: none;">
            <div class="download-container">
                <h3>üíæ Actualizar Datos en GitHub</h3>
                <p>Los datos han sido procesados exitosamente. Descarga el archivo data.json y s√∫belo a tu repositorio de GitHub para que todos puedan ver los datos actualizados.</p>
                <button class="btn-download" id="downloadBtn">üì• Descargar data.json</button>
            </div>
        </div>
    </div>

    <script>
        // Variables globales
        let experienceData = [];
        let campaignsData = [];
        let charts = {};
        const DATA_URL = './data.json'; // URL del archivo JSON en el mismo directorio

        // Inicializaci√≥n
        document.addEventListener('DOMContentLoaded', function() {
            loadDataFromJSON();
            initializeCharts();
            setupEventListeners();
        });

        function setupEventListeners() {
            document.getElementById('fileInput').addEventListener('change', handleFileUpload);
        }

        async function loadDataFromJSON() {
            try {
                const response = await fetch(DATA_URL);
                if (response.ok) {
                    const data = await response.json();
                    experienceData = data.experienceData || [];
                    campaignsData = data.campaignsData || [];
                    
                    if (experienceData.length > 0) {
                        updateDashboard();
                    }
                    if (campaignsData.length > 0) {
                        updateCampaignsTable();
                    }
                } else {
                    // Si no existe el archivo, intentar cargar de localStorage como fallback
                    loadStoredData();
                }
            } catch (error) {
                console.error('Error cargando datos JSON:', error);
                // Fallback a localStorage
                loadStoredData();
            }
        }

        function loadStoredData() {
            const storedExperience = localStorage.getItem('yopiverso_experience_data');
            const storedCampaigns = localStorage.getItem('yopiverso_campaigns_data');
            
            if (storedExperience) {
                experienceData = JSON.parse(storedExperience);
                updateDashboard();
            }
            
            if (storedCampaigns) {
                campaignsData = JSON.parse(storedCampaigns);
                updateCampaignsTable();
            }
        }

        function saveDataLocally() {
            // Guardar en localStorage
            localStorage.setItem('yopiverso_experience_data', JSON.stringify(experienceData));
            localStorage.setItem('yopiverso_campaigns_data', JSON.stringify(campaignsData));
            
            // Mostrar secci√≥n de descarga si hay datos
            if (experienceData.length > 0 || campaignsData.length > 0) {
                document.getElementById('downloadSection').style.display = 'block';
                
                // Configurar bot√≥n de descarga
                const downloadBtn = document.getElementById('downloadBtn');
                downloadBtn.onclick = function() {
                    const jsonData = {
                        lastUpdated: new Date().toISOString().split('T')[0],
                        experienceData: experienceData,
                        campaignsData: campaignsData
                    };
                    
                    const jsonStr = JSON.stringify(jsonData, null, 2);
                    const blob = new Blob([jsonStr], { type: 'application/json' });
                    const url = URL.createObjectURL(blob);
                    
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = 'data.json';
                    document.body.appendChild(a);
                    a.click();
                    document.body.removeChild(a);
                    URL.revokeObjectURL(url);
                    
                    // Mostrar mensaje de √©xito
                    const successMsg = document.getElementById('successMessage');
                    successMsg.textContent = '‚úÖ Archivo data.json descargado. S√∫belo a tu repositorio de GitHub.';
                    successMsg.classList.add('active');
                    setTimeout(() => successMsg.classList.remove('active'), 5000);
                };
            }
        }

        function handleFileUpload(event) {
            const files = event.target.files;
            const loading = document.getElementById('loading');
            const errorMsg = document.getElementById('errorMessage');
            const successMsg = document.getElementById('successMessage');
            const fileCount = document.getElementById('fileCount');
            
            // Resetear indicadores
            document.querySelectorAll('.file-indicator').forEach(el => el.classList.remove('loaded'));
            
            if (files.length === 0) return;
            
            loading.classList.add('active');
            errorMsg.classList.remove('active');
            successMsg.classList.remove('active');
            
            fileCount.textContent = `${files.length} archivo(s) seleccionado(s)`;
            
            let filesProcessed = 0;
            let csvFound = false;
            let excelFound = 0;
            
            Array.from(files).forEach(file => {
                const reader = new FileReader();
                
                reader.onload = function(e) {
                    const data = e.target.result;
                    
                    if (file.name.endsWith('.csv')) {
                        processCSV(data);
                        csvFound = true;
                        document.getElementById('csvIndicator').classList.add('loaded');
                    } else if (file.name.endsWith('.xlsx') || file.name.endsWith('.xls')) {
                        processExcel(data);
                        excelFound++;
                        if (excelFound === 1) {
                            document.getElementById('excel1Indicator').classList.add('loaded');
                        } else if (excelFound === 2) {
                            document.getElementById('excel2Indicator').classList.add('loaded');
                        }
                    }
                    
                    filesProcessed++;
                    
                    // Cuando se procesen todos los archivos
                    if (filesProcessed === files.length) {
                        loading.classList.remove('active');
                        
                        if (csvFound && excelFound >= 2) {
                            successMsg.textContent = '‚úÖ ¬°Todos los archivos cargados exitosamente! Dashboard actualizado.';
                            successMsg.classList.add('active');
                            fileCount.textContent = '¬°Carga completa! Los 3 archivos fueron procesados';
                            fileCount.style.color = '#4ecdc4';
                        } else {
                            let missing = [];
                            if (!csvFound) missing.push('CSV de Experiencia');
                            if (excelFound < 2) missing.push(`${2 - excelFound} archivo(s) Excel de Roblox`);
                            
                            errorMsg.textContent = `‚ö†Ô∏è Faltan archivos: ${missing.join(', ')}`;
                            errorMsg.classList.add('active');
                        }
                        
                        setTimeout(() => {
                            successMsg.classList.remove('active');
                            errorMsg.classList.remove('active');
                        }, 5000);
                    }
                };
                
                if (file.name.endsWith('.csv')) {
                    reader.readAsText(file);
                } else {
                    reader.readAsArrayBuffer(file);
                }
            });
        }

        function processCSV(data) {
            Papa.parse(data, {
                header: true,
                dynamicTyping: false, // Cambiado a false para mejor control
                skipEmptyLines: true,
                complete: function(results) {
                    // Limpiar y procesar datos con mejor manejo de formatos
                    const cleanedData = results.data.map(row => {
                        // Funci√≥n helper para convertir n√∫meros con coma decimal
                        const parseNumber = (value) => {
                            if (!value) return 0;
                            return parseFloat(String(value).replace(/\./g, '').replace(',', '.')) || 0;
                        };
                        
                        return {
                            fecha: row.Fecha,
                            usuariosActivos: parseNumber(row['Usuarios activos diarios']),
                            nuevosUsuarios: parseNumber(row['nuevos usuarios']),
                            tiempoSesion: parseNumber(row['tiempo de sesi√≥n promedio']),
                            retencion: parseNumber(row['retenci√≥n d√≠a 1']),
                            visitasTotales: parseInt(String(row['Visitas Totales']).replace(/\./g, '')) || 0
                        };
                    }).filter(row => row.fecha); // Filtrar filas vac√≠as
                    
                    experienceData = cleanedData;
                    saveDataLocally();
                    updateDashboard();
                }
            });
        }

        function processExcel(data) {
            try {
                const workbook = XLSX.read(data, { type: 'array' });
                const sheetName = workbook.SheetNames[0];
                const sheet = workbook.Sheets[sheetName];
                const jsonData = XLSX.utils.sheet_to_json(sheet);
                
                // Procesar datos de campa√±as
                const campaigns = jsonData.map(row => ({
                    name: row['Campaign Name'] || '',
                    objective: row['Objective'] || '',
                    budget: parseFloat(row['Budget']) || 0,
                    spent: parseFloat(row['Spent']) || 0,
                    impressions: parseInt(row['Impressions']) || 0,
                    plays: parseInt(row['Plays']) || 0,
                    cpp: parseFloat(row['CPP']) || 0,
                    startDate: row['Start Date'] || '',
                    endDate: row['End Date'] || '',
                    ctr: parseFloat(row['CTR']) || 0,
                    cpc: parseFloat(row['CPC']) || 0
                }));
                
                // Combinar campa√±as de ambos archivos Excel
                if (campaignsData.length === 0) {
                    campaignsData = campaigns;
                } else {
                    // Agregar nuevas campa√±as sin duplicar
                    campaigns.forEach(newCampaign => {
                        const exists = campaignsData.some(c => c.name === newCampaign.name);
                        if (!exists) {
                            campaignsData.push(newCampaign);
                        }
                    });
                }
                
                saveDataLocally();
                updateCampaignsTable();
            } catch (error) {
                console.error('Error procesando Excel:', error);
                showError('Error procesando archivo Excel');
            }
        }

        function applyFilters() {
            const startDate = document.getElementById('startDate').value;
            const endDate = document.getElementById('endDate').value;
            
            if (!startDate || !endDate) {
                showError('Por favor seleccione ambas fechas');
                return;
            }
            
            updateDashboard(startDate, endDate);
        }

        function resetFilters() {
            document.getElementById('startDate').value = '';
            document.getElementById('endDate').value = '';
            updateDashboard();
        }

        function showError(message) {
            const errorMsg = document.getElementById('errorMessage');
            errorMsg.textContent = message;
            errorMsg.classList.add('active');
            setTimeout(() => {
                errorMsg.classList.remove('active');
            }, 3000);
        }

        function updateDashboard(startDate = null, endDate = null) {
            let filteredData = experienceData;
            const dateInfo = document.getElementById('dateRangeInfo');
            
            if (startDate && endDate) {
                filteredData = experienceData.filter(row => {
                    const date = parseDate(row.fecha);
                    const start = new Date(startDate);
                    const end = new Date(endDate);
                    return date >= start && date <= end;
                });
                
                // Actualizar informaci√≥n del rango
                const startFormatted = new Date(startDate).toLocaleDateString('es-CL');
                const endFormatted = new Date(endDate).toLocaleDateString('es-CL');
                dateInfo.textContent = `Mostrando datos del ${startFormatted} al ${endFormatted} (${filteredData.length} d√≠as)`;
            } else {
                dateInfo.textContent = `Mostrando todos los datos disponibles (${filteredData.length} d√≠as)`;
            }
            
            if (filteredData.length === 0) {
                showError('No hay datos para el rango seleccionado');
                return;
            }
            
            updateMetrics(filteredData);
            updateCharts(filteredData);
        }

        function parseDate(dateStr) {
            const [day, month, year] = dateStr.split('/');
            return new Date(year, month - 1, day);
        }

        function updateMetrics(data) {
            if (data.length === 0) {
                // Resetear todas las m√©tricas a 0
                document.getElementById('totalUsers').textContent = '0';
                document.getElementById('newUsers').textContent = '0';
                document.getElementById('totalVisits').textContent = '0';
                document.getElementById('avgSessionTime').textContent = '0';
                document.getElementById('avgRetention').textContent = '0%';
                return;
            }
            
            // Para per√≠odos de m√∫ltiples d√≠as:
            // - Usuarios activos: promedio del per√≠odo (no se suman porque un usuario puede estar activo varios d√≠as)
            // - Nuevos usuarios: suma del per√≠odo (cada d√≠a son usuarios √∫nicos nuevos)
            // - Visitas: suma del per√≠odo
            // - Tiempo de sesi√≥n: promedio del per√≠odo
            // - Retenci√≥n: promedio del per√≠odo
            
            const avgActiveUsers = Math.round(data.reduce((sum, row) => sum + row.usuariosActivos, 0) / data.length);
            const totalNewUsers = data.reduce((sum, row) => sum + row.nuevosUsuarios, 0);
            const totalVisits = data.reduce((sum, row) => sum + row.visitasTotales, 0);
            const avgSession = data.reduce((sum, row) => sum + row.tiempoSesion, 0) / data.length;
            const avgRetention = (data.reduce((sum, row) => sum + row.retencion, 0) / data.length) * 100;
            
            // Si es un solo d√≠a, mostrar valores exactos
            if (data.length === 1) {
                document.getElementById('totalUsers').textContent = data[0].usuariosActivos.toLocaleString();
                document.getElementById('newUsers').textContent = data[0].nuevosUsuarios.toLocaleString();
                document.getElementById('totalVisits').textContent = data[0].visitasTotales.toLocaleString();
                document.getElementById('avgSessionTime').textContent = data[0].tiempoSesion.toFixed(1);
                document.getElementById('avgRetention').textContent = (data[0].retencion * 100).toFixed(1) + '%';
            } else {
                // Para m√∫ltiples d√≠as, mostrar agregados apropiados
                document.getElementById('totalUsers').textContent = avgActiveUsers.toLocaleString();
                document.getElementById('newUsers').textContent = totalNewUsers.toLocaleString();
                document.getElementById('totalVisits').textContent = totalVisits.toLocaleString();
                document.getElementById('avgSessionTime').textContent = avgSession.toFixed(1);
                document.getElementById('avgRetention').textContent = avgRetention.toFixed(1) + '%';
            }
        }

        function initializeCharts() {
            const chartOptions = {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        labels: {
                            color: '#ffffff'
                        }
                    }
                },
                scales: {
                    x: {
                        ticks: {
                            color: '#a0a0a0'
                        },
                        grid: {
                            color: 'rgba(255, 255, 255, 0.1)'
                        }
                    },
                    y: {
                        ticks: {
                            color: '#a0a0a0'
                        },
                        grid: {
                            color: 'rgba(255, 255, 255, 0.1)'
                        }
                    }
                }
            };
            
            // Gr√°fico de usuarios
            const usersCtx = document.getElementById('usersChart').getContext('2d');
            charts.users = new Chart(usersCtx, {
                type: 'line',
                data: {
                    labels: [],
                    datasets: [{
                        label: 'Usuarios Activos',
                        data: [],
                        borderColor: '#ff6b6b',
                        backgroundColor: 'rgba(255, 107, 107, 0.1)',
                        tension: 0.4
                    }, {
                        label: 'Nuevos Usuarios',
                        data: [],
                        borderColor: '#4ecdc4',
                        backgroundColor: 'rgba(78, 205, 196, 0.1)',
                        tension: 0.4
                    }]
                },
                options: chartOptions
            });
            
            // Gr√°fico de visitas
            const visitsCtx = document.getElementById('visitsChart').getContext('2d');
            charts.visits = new Chart(visitsCtx, {
                type: 'bar',
                data: {
                    labels: [],
                    datasets: [{
                        label: 'Visitas Totales',
                        data: [],
                        backgroundColor: 'rgba(78, 205, 196, 0.6)',
                        borderColor: '#4ecdc4',
                        borderWidth: 2
                    }]
                },
                options: chartOptions
            });
            
            // Gr√°fico de tiempo de sesi√≥n
            const sessionCtx = document.getElementById('sessionChart').getContext('2d');
            charts.session = new Chart(sessionCtx, {
                type: 'line',
                data: {
                    labels: [],
                    datasets: [{
                        label: 'Tiempo de Sesi√≥n (min)',
                        data: [],
                        borderColor: '#ffd93d',
                        backgroundColor: 'rgba(255, 217, 61, 0.1)',
                        tension: 0.4
                    }]
                },
                options: chartOptions
            });
            
            // Gr√°fico de retenci√≥n
            const retentionCtx = document.getElementById('retentionChart').getContext('2d');
            charts.retention = new Chart(retentionCtx, {
                type: 'line',
                data: {
                    labels: [],
                    datasets: [{
                        label: 'Retenci√≥n D√≠a 1 (%)',
                        data: [],
                        borderColor: '#a29bfe',
                        backgroundColor: 'rgba(162, 155, 254, 0.1)',
                        tension: 0.4
                    }]
                },
                options: chartOptions
            });
        }

        function updateCharts(data) {
            const labels = data.map(row => row.fecha);
            
            // Actualizar gr√°fico de usuarios
            charts.users.data.labels = labels;
            charts.users.data.datasets[0].data = data.map(row => row.usuariosActivos);
            charts.users.data.datasets[1].data = data.map(row => row.nuevosUsuarios);
            charts.users.update();
            
            // Actualizar gr√°fico de visitas
            charts.visits.data.labels = labels;
            charts.visits.data.datasets[0].data = data.map(row => row.visitasTotales);
            charts.visits.update();
            
            // Actualizar gr√°fico de tiempo de sesi√≥n
            charts.session.data.labels = labels;
            charts.session.data.datasets[0].data = data.map(row => row.tiempoSesion);
            charts.session.update();
            
            // Actualizar gr√°fico de retenci√≥n
            charts.retention.data.labels = labels;
            charts.retention.data.datasets[0].data = data.map(row => row.retencion * 100);
            charts.retention.update();
        }

        function updateCampaignsTable() {
            const tbody = document.getElementById('campaignsBody');
            const container = document.getElementById('campaignsTableContainer');
            
            if (campaignsData.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="8" style="text-align: center; color: #a0a0a0;">
                            No hay datos de campa√±as cargados
                        </td>
                    </tr>
                `;
                return;
            }
            
            tbody.innerHTML = '';
            
            campaignsData.forEach(campaign => {
                const row = document.createElement('tr');
                const isActive = !campaign.endDate || new Date(campaign.endDate) > new Date();
                
                row.innerHTML = `
                    <td>${campaign.name}</td>
                    <td>${campaign.objective}</td>
                    <td>${campaign.budget.toLocaleString()}</td>
                    <td>${campaign.spent.toFixed(2)}</td>
                    <td>${campaign.impressions.toLocaleString()}</td>
                    <td>${campaign.plays.toLocaleString()}</td>
                    <td>${campaign.cpp.toFixed(3)}</td>
                    <td><span class="status-badge ${isActive ? 'status-active' : 'status-completed'}">${isActive ? 'Activa' : 'Completada'}</span></td>
                `;
                tbody.appendChild(row);
            });
            
            // Asegurar que la tabla sea visible
            container.style.display = 'block';
        }
    </script>
</body>
</html>
  
